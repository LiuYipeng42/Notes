## Java堆溢出

​		Java 堆用于储存对象实例，我们只要**不断地创建对象**，并且保证 GC Roots 到对象之间有可达路径来避免垃圾回收机制清除这些对象，那么随着对象数量的增加，总容量触及最大堆的容量限制后**就会产生内存溢出异常**。

​		常规的处理方法是首先通过内存映像分析工具对 Dump 出来的堆转储快照进行分析。第一步首先应确认内存中导致 OOM 的**对象是否是必要**的，也就是要先分清楚到底是出现了**内存泄漏**（Memory Leak）还是**内存溢出**（Memory Overflow）。

​		如果是**内存泄漏**，表明有一些对象需要被回收，但垃圾收集器没有回收。可通过工具查看泄漏对象到 GC Roots 的引用链，找到泄漏对象是通过怎样的引用路径、 与哪些 GC Roots 相关联，**才导致垃圾收集器无法回收**它们。

​		如果是**内存溢出**，表明大多数对象都是必须要存在的。此时就应当检查 Java 虚拟机的**堆参数**（-Xmx 与-Xms）设置，与机器的内存对比，看看是否还有**向上调整的空间**。再从代码上检查是否存在某些**对象生命周期过长**、**持有状态时间过长**、**存储结构设计不合理**等情况，尽量减少程序运行期的内存消耗。



**控制Java堆大小的虚拟机参数**

​	**最大值** ：-Xmx 

​	**最小值**  ：-Xms 

参数 **-XX：+HeapDumpOnOutOf-MemoryError **

可以让虚拟机在出现内存溢出异常的时候 Dump 出当前的内存堆转储快照以便进行事后分析

**e.g.**

​	VM Args：-Xms20m -Xmx20m -XX:+HeapDumpOnOutOfMemoryError



## 虚拟机栈和本地方法栈溢出

​		虚拟机栈和本地方法栈有**两种异常**：

​		1. 如果线程请求的栈深度大于虚拟机所允许的最大深度，将抛出**StackOverflowError** 异常。

​		2. 如果虚拟机的栈内存允许动态扩展，当扩展栈容量无法申请到足够的内存时，将抛出			**OutOfMemoryError** 异常。

​		因为**HotSpot 虚拟机**的选择是不支持扩展，所以**只有StackOverflowError异常**。



**控制虚拟机栈和本地方法栈大小的虚拟机参数**

​	**本地方法栈**大小：-Xoss （没有任何效果）

​	**虚拟机栈**大小：-Xss

**e.g.**

​	VM Args： -Xss128k





## 方法区和运行时常量池溢出

​		**运行时常量池是方法区的一部分**，自 JDK 7 起，原本存放在永久代的字符串常量池被移至 Java 堆之中，所以在 JDK 7 及以上版本，限制方法区的容量是毫无意义的。这时候使用-Xmx 参数限制最大值就能够看到OutOfMemoryError异常。

​		**方法区溢出**是一种常见的内存溢出异常，一个类如果要被垃圾收集器回收，要达成的条件是比较苛刻的。在经常运行时生成大量动态类的应用场景里，就应该特别关注这些类的回收状况



**控制方法区大小的虚拟机参数**

​	大小限制：-XX: MaxMeta-spaceSize

并不会有多大的效果，因为方法区在Java 堆之中。

**e.g.**

​	VM Args：-XX: MaxMeta-spaceSize=6M



方法区是用元空间实现的，以下为**元空间的参数**。

**-XX: MaxMetaspaceSize**：

​		设置元空间最大值，默认是-1，即不限制，或者说只受限于本地内存大小。

**XX: MetaspaceSize**：

​		指定元空间的初始空间大小，以字节为单位，达到该值就会触发垃圾收集进行类型卸		载，同时收集器会对该值进行调整：如果释放了大量的空间，就适当降低该值；如果释放了很少的空间，		那么在不超过-XX：MaxMetaspaceSize（如果设置了的话）的情况下，适当提高该值。

**-XX: MinMetaspaceFreeRatio**：

​		作用是在垃圾收集之后控制最小的元空间剩余容量的百分比，可减少因为元空间不足导致的垃圾收集的频率。类似的还有-XX： MaxMetaspaceFreeRatio，用于控制最大的元空间剩余容量的百分比。



## 直接内存溢出

​		由直接内存导致的内存溢出，一个明显的特征是在 Heap Dump 文件中不会看见有什么明显的异常情况，如果读者发现内存溢出之后产生的 Dump 文件很小，而程序中又直接或间接使用了 DirectMemory（典型的间接使用就是 NIO），那就可以考虑重点检查一下直接内存方面的原因了。



**控制直接内存大小的虚拟机参数**

可通过-XX： MaxDirectMemorySize 参数来指定，

如果不去指定，则默认与 Java 堆最大值（由-Xmx 指定）一致，

